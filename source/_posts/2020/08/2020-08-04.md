---
title: 回線を増やした
date: 2020-08-04
tags: ゲーム
---

7月30日の夜から翌日にかけて SoftBank 光の回線障害が断続的に発生した。

同サービスのユーザーであった私も影響を受けた（が、30日夜に関しては Youtube だけ見ていたので気づかず、翌朝起きがけにスマホでブラウジングしようとして異常に気づいた）。

## 前提

### 状況を確認する

* スリープしていたPCを立ち上げて、たまたま開かれていた Youtube をリロードして確認するとなぜか視聴可能
* しかし Twitter クライアントは通信エラーを出している
* Google Public DNS に向けて ping するとタイムアウトする

### 推測

* IPv6 は DNS 含めてすべて動いている
* IPv4 ネットワークだけ何らかの理由でダウンしている（IXとの接続点の輻輳だと思っていたが、実際は外部からの異常なトラフィック増大だったらしい）

## 回線を増やす判断

業務で使っている Web サービスのうちいくつかが IPv4 ベースの接続なのと、待てば改善するかどうかも不明、DNS障害のように一時的な回避策も特に思い当たらなかったので、~~業務できなくても言い訳になるな~~ 朝の業務開始までに復旧しとかなければと考え、インターリンクの [ZOOT NEXT for フレッツ光](https://www.interlink.or.jp/service/flets/b/)（の無料体験）に申し込みを行った。
申し込んでほぼ即時でPPPのユーザー情報を発行、無料体験は2ヶ月（だが月末に申し込んだので8月末まで）というなかなかにスピード感のあるサービスである。月額も1000円ちょっとではあるので、スタンバイ用の回線として寝かせておいても良いと考えた。

ソフトバンク光の IPv6 のパフォーマンスは非常に高い（このことはあまり知られていないが、知られていないが故にそうなのだと思う）ため、これは活かしておきたいと考えた。

* IPv6 はそのまま
* IPv4 の通信だけをインターリンク経由にする

という方針で通信の安定化を考えた。

### 当初の方針

ソフトバンクから貸与されているHGWにPPPoEで2セッション目を張れそうな機能があったので検討した。しかし下記の理由で断念。

* IPv4 の通信全体を曲げられるものではなく、宛先ドメイン or IP を指定（件数限界あり）して通信を曲げるような設定しか無かった。
* 広範囲の CIDR を指定できるものではなかった（Webベースの管理画面をいじって無理やり 0.0.0.0/0 などを入れても動作せず）

### 最終的な方針

インターリンクの[マルチセッション利用のページ](https://www.interlink.or.jp/service/flets/multisession.html)に記載があった構成（方法1）をベースとして組み直した。

* ONUからスイッチングハブでゲートウェイを2つぶら下げる
* 内部セグメントにも2つのゲートウェイを配置しデフォルトゲートウェイ切り替えで主副切り替え

![network](/images/0804a.png)

最終的にはこれで落ち着いた。

## まだ残る問題点

DHCPv6 を稼働させるためにソフトバンク光の HGW 側で DHCP サーバ機能を有効にしたいが、それに伴って DHCPv4 だけを止めることができず、**DHCPv4 で配布するデフォルトゲートウェイを HGW 自身のIPアドレス以外に変更できない** ことがわかった。

これはどういうことかというと、もしソフトバンク光の IPv4 ネットワークに再び障害が発生したときに、端末単位で v4 ゲートウェイの手動設定を強いるか、DHCPv6 が停止するのを覚悟で、インターリンク向けのゲートウェイ側（ゲートウェイのIPを自由に設定可能）にDHCPサーバ機能を手動で移行するしか方法がないということだ。
これは非常にめんどくさいが、一方でめんどくさい以外の害はないので一旦許容範囲ではないかと考えることにする。

## なんか気になったこと

SNSでは過去のDNS障害のときの一時回避策（具体的には端末のDNS設定を Google や Cloudflare などの Public DNSに する）がメチャメチャに叫ばれていて、DNS以前にネットワーク自体が疎通しない問題であることは、それこそ 8.8.8.8 なんかに ping すれば 10　秒でわかるものなのになぁ、と思わずむず痒くなってしまった。

自分の家のインフラやネットワークがどういう状態かを調査もしない/できない人がこれだけ多いとテレワークとか無理なんじゃないかと思った。別に全員がプロであれとは思わないけれども、自分が普段使っているものに関してくらいもう少し興味や知識があってもよいのではないかなぁ……。
